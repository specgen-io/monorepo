version: 2.1

orbs:
  artifactory: specgen/artifactory@0.7.0

parameters:
  specgen-version:
    type: string
    default: 2.1.<<pipeline.number>>
  specgen-version-major:
    type: string
    default: v2
  rendr-version:
    type: string
    default: v0.0.59

jobs:
  specgen:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/specgen
    steps:
      - checkout
      - restore_cache:
          key: cache-{{ checksum "./codegen/specgen/go.sum"  }}
      - run:
          name: Build
          command: |
            cd codegen/specgen
            ../build.sh <<pipeline.parameters.specgen-version>>
      - save_cache:
          key: cache-{{ checksum "./codegen/specgen/go.sum"  }}
          paths:
            - ~/go/pkg/mod
      - run:
          name: Unit tests
          command: |
            cd codegen/specgen
            mkdir -p ./test-results
            go install github.com/jstemmer/go-junit-report@latest
            go test ./... -v 2>&1 | go-junit-report > ./test-results/go-test-report.xml
      - store_test_results:
          path: ./specgen/test-results
      - persist_to_workspace:
          root: .
          paths:
            - codegen/specgen/dist
      - run:
          name: Release
          command: |
            cd codegen/specgen
            ./release.sh <<pipeline.parameters.specgen-version>> artifactory

  golang:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/golang
    steps:
      - checkout
      - run:
          name: Build golang codegen
          command: |
            cd codegen/golang
            go build

  golang-release:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/golang
    steps:
      - run:
          name: Release vendored module
          command: |
            go install github.com/specgen-io/goven@v0.0.10
            cd codegen/golang
            goven release -name github.com/specgen-io/specgen-golang/<<pipeline.parameters.specgen-version-major>> -version v<<pipeline.parameters.specgen-version>> -out vendored
      - run:
          name: Check tool installation
          command: |
            go install github.com/specgen-io/specgen-golang/<<pipeline.parameters.specgen-version-major>>@v<<pipeline.parameters.specgen-version>>
            specgen-golang --help

  ruby:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/specgen
    steps:
      - build_specgen_plugin:
          plugin-path: codegen/ruby

  gem:
    docker:
      - image: circleci/ruby:2.4.9
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/ruby
          at: ./plugins/gem-specgen/lib
      - run:
          name: Build gem
          command: |
            cd ./plugins/gem-specgen
            export VERSION=<<pipeline.parameters.specgen-version>>
            gem build specgen.gemspec
      - setup-gems:
          jfrog-server-url: specgen.jfrog.io
          repo-name: gems
      - run:
          name: Push gem
          command: |
            cd ./plugins/gem-specgen
            export VERSION=<<pipeline.parameters.specgen-version>>
            gem push specgen-$VERSION.gem --host https://specgen.jfrog.io/artifactory/api/gems/gems

  gem-rubygems:
    docker:
      - image: circleci/ruby:2.4.9
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/ruby
          at: ./plugins/gem-specgen/lib
      - run:
          name: Build gem
          command: |
            cd ./plugins/gem-specgen
            export VERSION=<<pipeline.parameters.specgen-version>>
            gem build specgen.gemspec
      - setup-rubygems
      - run:
          name: Push gem
          command: |
            cd ./plugins/gem-specgen
            export VERSION=<<pipeline.parameters.specgen-version>>
            gem push --key rubygems specgen-$VERSION.gem


  scala:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/specgen
    steps:
      - build_specgen_plugin:
          plugin-path: codegen/scala

  sbt:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/scala
          at: ./plugins/sbt-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/sbt-specgen/build.sbt" }}
      - artifactory/setup-sbt:
          jfrog-server-url: specgen.jfrog.io
          repo-name: sbt
      - run:
          name: Build SBT plugin
          command: |
            cd ./plugins/sbt-specgen
            sbt -Dversion=<<pipeline.parameters.specgen-version>> clean test
      - run:
          name: Publish SBT plugin
          command: |
            cd ./plugins/sbt-specgen
            sbt -Dversion=<<pipeline.parameters.specgen-version>> publish
      - save_cache:
          key: cache-{{ checksum "./plugins/sbt-specgen/build.sbt" }}
          paths:
            - ~/.sbt
            - ~/.ivy2
            - ~/.m2

  sbt-sonatype:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/scala
          at: ./plugins/sbt-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/sbt-specgen/build.sbt" }}
      - setup-sonatype-sbt
      - run:
          name: Publish SBT plugin
          command: |
            cd ./plugins/sbt-specgen
            sbt -Dversion=<<pipeline.parameters.specgen-version>> publishSigned sonatypeRelease


  typescript:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/specgen
    steps:
      - build_specgen_plugin:
          plugin-path: codegen/typescript

  npm-typescript:
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/typescript
          at: ./plugins/npm-specgen
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
      - run:
          name: npm publish package
          command: |
            cd ./plugins/npm-specgen
            npm pkg set name=@specgen.io/specgen.io
            npm version <<pipeline.parameters.specgen-version>>
            npm install
            npm publish

  npm-npmjs:
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/typescript
          at: ./plugins/npm-specgen
      - run:
          name: npm publish package
          command: |
            if [[ $CIRCLE_BRANCH == main ]] || [[ $CIRCLE_BRANCH == v* ]]; then
              cd ./plugins/npm-specgen
              npm version <<pipeline.parameters.specgen-version>>
              npm install
              npm publish
            else
              echo "Will not release - not running on main branch"
            fi

  java:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/specgen
    steps:
      - build_specgen_plugin:
          plugin-path: codegen/java

  maven-java:
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/java
          at: ./plugins/maven-java-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/maven-java-specgen/pom.xml" }}
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - run:
          name: Build Maven plugin
          command: |
            cd ./plugins/maven-java-specgen
            sed -i.bak 's/PROJECT_VERSION/<<pipeline.parameters.specgen-version>>/g' pom.xml
            mvn clean install
      - run:
          name: Deploy Maven plugin
          command: |
            cd ./plugins/maven-java-specgen
            mvn deploy -Dartifactory=true
      - save_cache:
          key: cache-{{ checksum "./plugins/maven-java-specgen/pom.xml" }}
          paths:
            - ~/.ivy2
            - ~/.m2

  maven-java-sonatype:
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/java
          at: ./plugins/maven-java-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/maven-java-specgen/pom.xml" }}
      - setup-sonatype-maven
      - run:
          name: Deploy Maven plugin
          command: |
            cd ./plugins/maven-java-specgen
            sed -i.bak 's/PROJECT_VERSION/<<pipeline.parameters.specgen-version>>/g' pom.xml
            export GPG_TTY=$(tty)
            mvn deploy -Dgpg.passphrase=$SONATYPE_GPG_PASSPHRASE -Dsonatype=true
      - save_cache:
          key: cache-{{ checksum "./plugins/maven-java-specgen/pom.xml" }}
          paths:
            - ~/.ivy2
            - ~/.m2

  gradle-java:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/java
          at: ./plugins/gradle-java-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/gradle-java-specgen/build.gradle.kts" }}-{{ checksum "./plugins/gradle-java-specgen/settings.gradle.kts" }}
      - run:
          name: Build Gradle plugin
          command: |
            cd ./plugins/gradle-java-specgen
            ./gradlew build --build-cache --no-daemon -Pproject.version=<<pipeline.parameters.specgen-version>>
      - run:
          name: Deploy Gradle plugin
          command: |
            cd ./plugins/gradle-java-specgen
            ./gradlew publishAllPublicationsToArtifactoryRepository --build-cache --no-daemon \
            -Djfrog.user=$JFROG_USER \
            -Djfrog.pass=$JFROG_PASS \
            -Dproject.version=<<pipeline.parameters.specgen-version>>
      - save_cache:
          key: cache-{{ checksum "./plugins/gradle-java-specgen/build.gradle.kts" }}-{{ checksum "./plugins/gradle-java-specgen/settings.gradle.kts" }}
          paths: [ ~/.gradle ]

  gradle-java-pluginportal:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/java
          at: ./plugins/gradle-java-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/gradle-java-specgen/build.gradle.kts" }}-{{ checksum "./plugins/gradle-java-specgen/settings.gradle.kts" }}
      - run:
          name: Deploy Gradle Java plugin
          command: |
            cd ./plugins/gradle-java-specgen
            ./gradlew publishPlugins --build-cache --no-daemon \
            -Pgradle.publish.key=$GRADLE_PUBLISH_KEY \
            -Pgradle.publish.secret=$GRADLE_PUBLISH_SECRET \
            -Dproject.version=<<pipeline.parameters.specgen-version>>


  kotlin:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/specgen
    steps:
      - build_specgen_plugin:
          plugin-path: codegen/kotlin

  maven-kotlin:
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/kotlin
          at: ./plugins/maven-kotlin-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/maven-kotlin-specgen/pom.xml" }}
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - run:
          name: Build Maven plugin
          command: |
            cd ./plugins/maven-kotlin-specgen
            sed -i.bak 's/PROJECT_VERSION/<<pipeline.parameters.specgen-version>>/g' pom.xml
            mvn clean install
      - run:
          name: Deploy Maven plugin
          command: |
            cd ./plugins/maven-kotlin-specgen
            sed -i.bak 's/PROJECT_VERSION/<<pipeline.parameters.specgen-version>>/g' pom.xml
            mvn deploy -Dartifactory=true
      - save_cache:
          key: cache-{{ checksum "./plugins/maven-kotlin-specgen/pom.xml" }}
          paths:
            - ~/.ivy2
            - ~/.m2

  maven-kotlin-sonatype:
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/kotlin
          at: ./plugins/maven-kotlin-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/maven-kotlin-specgen/pom.xml" }}
      - setup-sonatype-maven
      - run:
          name: Deploy Maven plugin
          command: |
            cd ./plugins/maven-kotlin-specgen
            sed -i.bak 's/PROJECT_VERSION/<<pipeline.parameters.specgen-version>>/g' pom.xml            
            export GPG_TTY=$(tty)
            mvn deploy -Dgpg.passphrase=$SONATYPE_GPG_PASSPHRASE -Dsonatype=true
      - save_cache:
          key: cache-{{ checksum "./plugins/maven-kotlin-specgen/pom.xml" }}
          paths:
            - ~/.ivy2
            - ~/.m2

  gradle-kotlin:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/kotlin
          at: ./plugins/gradle-kotlin-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/gradle-kotlin-specgen/build.gradle.kts" }}-{{ checksum "./plugins/gradle-kotlin-specgen/settings.gradle.kts" }}
      - run:
          name: Build Gradle plugin
          command: |
            cd ./plugins/gradle-kotlin-specgen
            ./gradlew build --build-cache --no-daemon -Pproject.version=<<pipeline.parameters.specgen-version>>
      - run:
          name: Deploy Gradle plugin
          command: |
            cd ./plugins/gradle-kotlin-specgen
            ./gradlew publishAllPublicationsToArtifactoryRepository --build-cache --no-daemon \
            -Djfrog.user=$JFROG_USER \
            -Djfrog.pass=$JFROG_PASS \
            -Dproject.version=<<pipeline.parameters.specgen-version>>
      - save_cache:
          key: cache-{{ checksum "./plugins/gradle-kotlin-specgen/build.gradle.kts" }}-{{ checksum "./plugins/gradle-kotlin-specgen/settings.gradle.kts" }}
          paths: [ ~/.gradle ]

  gradle-kotlin-pluginportal:
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/kotlin
          at: ./plugins/gradle-kotlin-specgen/src/main/resources
      - restore_cache:
          key: cache-{{ checksum "./plugins/gradle-kotlin-specgen/build.gradle.kts" }}-{{ checksum "./plugins/gradle-kotlin-specgen/settings.gradle.kts" }}
      - run:
          name: Deploy Gradle Kotlin plugin
          command: |
            cd ./plugins/gradle-kotlin-specgen
            ./gradlew publishPlugins --build-cache --no-daemon \
            -Pgradle.publish.key=$GRADLE_PUBLISH_KEY \
            -Pgradle.publish.secret=$GRADLE_PUBLISH_SECRET \
            -Dproject.version=<<pipeline.parameters.specgen-version>>


  specgen-release:
    docker:
      - image: cimg/go:1.16.4
    working_directory: ~/specgen
    steps:
      - checkout
      - attach_workspace_folder:
          folder: codegen/specgen
          at: ./specgen
      - run:
          name: Release
          command: |
            cd codegen/specgen
            ./release.sh <<pipeline.parameters.specgen-version>> github+artifactory
      - run:
          name: Cleanup
          command: |
            cd codegen/specgen
            rm *.zip
            rm -rf ./dist
            rm -rf ./test-results
            rm ./release.sh
      - run:
          name: Vendor code with goven
          command: |
            cd codegen/specgen
            go install github.com/specgen-io/goven@v0.0.10
            goven release -name github.com/specgen-io/specgen/<<pipeline.parameters.specgen-version-major>> -version v<<pipeline.parameters.specgen-version>> -out vendored
      - run:
          name: Check released module
          command: |
            go install github.com/specgen-io/specgen/<<pipeline.parameters.specgen-version-major>>@v<<pipeline.parameters.specgen-version>>
            specgen --help


  models-golang:
    working_directory: ~/test-models-go
    docker:
      - image: cimg/go:1.18.3
    steps:
      - checkout
      - install_specgen_golang
      - run:
          name: Test Go models
          command: |
            cd ./test-models/go
            go generate
            mkdir -p ./test-results
            go install github.com/jstemmer/go-junit-report@v0.9.1
            go test ./... -v 2>&1 | go-junit-report > ./test-results/go-test-report.xml
      - store_test_results:
          path: ./test-models/go/test-results
  models-ruby:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/test-models-ruby
    docker:
      - image: cimg/ruby:3.0.0
    steps:
      - checkout
      - artifactory/setup-bundler:
          jfrog-server-url: specgen.jfrog.io
      - run:
          name: Setup Gemfile
          command: |
            cd ./test-models/ruby
            tee --append ./Gemfile \<<END
            source 'https://specgen.jfrog.io/artifactory/api/gems/gems/' do
              gem 'specgen', '<< pipeline.parameters.specgen-version >>'
            end
            END
      - restore_cache:
          keys:
            - cache-{{ checksum "./tests-models/ruby/Gemfile" }}
      - run:
          name: Test Ruby models
          command: |
            cd ./test-models/ruby
            bundle install
            rake
      - save_cache:
          key: cache-{{ checksum "./test-models/ruby/Gemfile" }}
          paths:
            - ~/test-models-ruby/ruby/vendor/bundle
      - store_test_results:
          path: ./test-models/ruby/test-results
  models-ts-superstruct:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/test-models-superstruct
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
          scope: specgen.io
      - run:
          name: Setup npm
          command: |
            cd ./test-models/ts-superstruct
            npm install @specgen.io/specgen.io@$SPECGEN_VERSION --save-dev
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-models/ts-superstruct/package.json" }}
      - run:
          name: Test Superstruct models
          command: |
            cd ./test-models/ts-superstruct
            npm install
            npm run specgen
            mkdir -p ./test-results
            export JEST_JUNIT_OUTPUT_DIR=./test-results
            npm run test
      - save_cache:
          key: cache-{{ checksum "./test-models/ts-superstruct/package.json" }}
          paths:
            - ~/test-models-superstruct/ts-superstruct/node_modules
      - store_test_results:
          path: ./test-models/ts-superstruct/test-results
  models-ts-iots:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/test-models-iots
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
          scope: specgen.io
      - run:
          name: Setup npm
          command: |
            cd ./test-models/ts-iots
            npm install @specgen.io/specgen.io@$SPECGEN_VERSION --save-dev
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-models/ts-iots/package.json" }}
      - run:
          name: Test Iots models
          command: |
            cd ./test-models/ts-iots
            npm install
            npm run specgen
            mkdir -p ./test-results
            export JEST_JUNIT_OUTPUT_DIR=./test-results
            npm run test
      - save_cache:
          key: cache-{{ checksum "./test-models/ts-iots/package.json" }}
          paths:
            - ~/test-models-iots/ts-iots/node_modules
      - store_test_results:
          path: ./test-models/ts-iots/test-results
  models-scala-circe:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/test-models-circe
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-models/scala-circe/build.sbt" }}
      - artifactory/setup-sbt:
          jfrog-server-url: specgen.jfrog.io
          repo-name: sbt
      - run:
          name: Test Circe models
          command: |
            cd ./test-models/scala-circe
            mkdir -p ./test-results
            sbt -Djunitxml=./test-results test < /dev/null
      - store_test_results:
          path: ./test-models/test-models/scala-circe/test-results
      - save_cache:
          key: cache-{{ checksum "./test-models/scala-circe/build.sbt" }}
          paths:
            - ~/.sbt
            - ~/.ivy2
  models-java-jackson:
    working_directory: ~/test-models-java-jackson
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-models/java-jackson/pom.xml" }}
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - run:
          name: Maven build
          command: |
            cd ./test-models/java-jackson
            mkdir -p ./test-results
            mvn clean test -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-models/java-jackson/test-results
      - save_cache:
          key: cache-{{ checksum "./test-models/java-jackson/pom.xml" }}
          paths:
            - ~/.m2
  models-java-moshi:
    working_directory: ~/test-models-java-moshi
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-models/java-moshi/pom.xml" }}
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - run:
          name: Maven build
          command: |
            cd ./test-models/java-moshi
            mkdir -p ./test-results
            mvn clean test -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-models/java-moshi/test-results
      - save_cache:
          key: cache-{{ checksum "./test-models/java-moshi/pom.xml" }}
          paths:
            - ~/.m2

  models-kotlin:
    parameters:
      values-file:
        type: string
    environment:
      SPECGEN_VERSION: <<pipeline.parameters.specgen-version>>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - run:
          name: Create temp folder for tests results
          command: mkdir -p /tmp/test-results
      - get-rendr
      - run:
          name: Copy spec.yaml
          command: |
            cd test-models
            cp ./spec.yaml ./kotlin/template/spec.yaml
      - run:
          name: Generate models
          command: |
            export THE_ROOT=./test-models/kotlin
            ./rendr file:///./templates/models-kotlin --root file:///${THE_ROOT}/template --noinput --values ${THE_ROOT}/<<parameters.values-file>>.json --set versions.specgen=${SPECGEN_VERSION} --out ${THE_ROOT}/out
      - artifactory/setup-gradle-kotlin:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
          project-path: ./test-models/kotlin/out
      - restore_cache:
          key: kotlin-<<parameters.values-file>>
      - yaml-execute:
          path: ./test-models/kotlin/out
          yaml-file: .rendr.yaml
          yaml-path: .build
      - yaml-execute:
          path: ./test-models/kotlin/out
          yaml-file: .rendr.yaml
          yaml-path: .run
          background: true
      - save_cache:
          key: kotlin-<<parameters.values-file>>
          paths: [ ~/.gradle ]

  client-test-service:
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/go:1.18.3
    steps:
      - checkout
      - install_specgen_golang
      - run:
          name: Build test-service
          command: |
            cd ./test-clients/test-service
            go generate
            go build -o test-service
      - persist_to_workspace:
          root: .
          paths:
            - test-clients/test-service

  client-golang:
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/go:1.18.3
    steps:
      - checkout
      - attach_workspace:
          at: .
      - start-service:
          port: 8081
      - install_specgen_golang
      - run:
          name: Test Go client
          command: |
            cd ./test-clients/go
            go generate
            mkdir -p ./test-results
            go install github.com/jstemmer/go-junit-report@v0.9.1
            go test ./... -v
            go test ./... -v 2>&1 | go-junit-report > ./test-results/go-test-report.xml
      - store_test_results:
          path: ./test-clients/go/test-results

  client-java-okhttp-jackson:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/java-okhttp-jackson/pom.xml" }}
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - start-service:
          port: 8081
      - run:
          name: Test Java OkHttp client
          command: |
            cd ./test-clients/java-okhttp-jackson
            mkdir -p ./test-results
            mvn clean test -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-clients/java-okhttp-jackson/test-results
      - save_cache:
          key: cache-{{ checksum "./test-clients/java-okhttp-jackson/pom.xml" }}
          paths:
            - ~/.m2

  client-java-okhttp-moshi:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/java-okhttp-moshi/pom.xml" }}
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - start-service:
          port: 8081
      - run:
          name: Test Java OkHttp client
          command: |
            cd ./test-clients/java-okhttp-moshi
            mkdir -p ./test-results
            mvn clean test -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-clients/java-okhttp-moshi/test-results
      - save_cache:
          key: cache-{{ checksum "./test-clients/java-okhttp-moshi/pom.xml" }}
          paths:
            - ~/.m2

  client-java-micronaut-jackson:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/java-micronaut-jackson/pom.xml" }}
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - start-service:
          port: 8081
      - run:
          name: Test Java Micronaut client
          command: |
            cd ./test-clients/java-micronaut-jackson
            mkdir -p ./test-results
            mvn clean test -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-clients/java-micronaut-jackson/test-results
      - save_cache:
          key: cache-{{ checksum "./test-clients/java-micronaut-jackson/pom.xml" }}
          paths:
            - ~/.m2          

  client-kotlin-okhttp-jackson:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          key: cache-{{ checksum "./test-clients/kotlin-okhttp-jackson/build.gradle.kts" }}-{{ checksum "./test-clients/kotlin-okhttp-jackson/settings.gradle.kts" }}
      - start-service:
          port: 8081
      - run:
          name: Test Kotlin OkHttp client
          command: |
            cd ./test-clients/kotlin-okhttp-jackson
            ./gradlew --build-cache --no-daemon --stacktrace test \
            -Djfrog.user=$JFROG_USER \
            -Djfrog.pass=$JFROG_PASS \
            -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-clients/kotlin-okhttp-jackson/build/test-results
      - save_cache:
          key: cache-{{ checksum "./test-clients/kotlin-okhttp-jackson/build.gradle.kts" }}-{{ checksum "./test-clients/kotlin-okhttp-jackson/settings.gradle.kts" }}
          paths: [ ~/.gradle ]

  client-kotlin-okhttp-moshi:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          key: cache-{{ checksum "./test-clients/kotlin-okhttp-moshi/build.gradle.kts" }}-{{ checksum "./test-clients/kotlin-okhttp-moshi/settings.gradle.kts" }}
      - start-service:
          port: 8081
      - run:
          name: Test Kotlin OkHttp client
          command: |
            cd ./test-clients/kotlin-okhttp-moshi
            ./gradlew --build-cache --no-daemon --stacktrace test \
            -Djfrog.user=$JFROG_USER \
            -Djfrog.pass=$JFROG_PASS \
            -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-clients/kotlin-okhttp-moshi/build/test-results
      - save_cache:
          key: cache-{{ checksum "./test-clients/kotlin-okhttp-moshi/build.gradle.kts" }}-{{ checksum "./test-clients/kotlin-okhttp-moshi/settings.gradle.kts" }}
          paths: [ ~/.gradle ]

  client-kotlin-micronaut-jackson:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          key: cache-{{ checksum "./test-clients/kotlin-micronaut-jackson/build.gradle.kts" }}-{{ checksum "./test-clients/kotlin-micronaut-jackson/settings.gradle.kts" }}
      - start-service:
          port: 8081
      - run:
          name: Test Kotlin Micronaut client
          command: |
            cd ./test-clients/kotlin-micronaut-jackson
            ./gradlew --build-cache --no-daemon --stacktrace test \
            -Djfrog.user=$JFROG_USER \
            -Djfrog.pass=$JFROG_PASS \
            -Dspecgen.version=<<pipeline.parameters.specgen-version>>
      - store_test_results:
          path: ./test-clients/kotlin-micronaut-jackson/build/test-results
      - save_cache:
          key: cache-{{ checksum "./test-clients/kotlin-micronaut-jackson/build.gradle.kts" }}-{{ checksum "./test-clients/kotlin-micronaut-jackson/settings.gradle.kts" }}
          paths: [ ~/.gradle ]

  client-ruby:
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/ruby:2.4.9
    steps:
      - checkout
      - attach_workspace:
          at: .
      - artifactory/setup-bundler:
          jfrog-server-url: specgen.jfrog.io
      - start-service:
          port: 8081
      - run:
          name: Setup Gemfile
          command: |
            cd ./test-clients/ruby
            tee --append ./Gemfile \<<END

            source 'https://specgen.jfrog.io/artifactory/api/gems/gems/' do
              gem 'specgen', '<< pipeline.parameters.specgen-version >>'
            end
            END
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/ruby/Gemfile.lock" }}
      - run:
          name: Test Ruby client
          command: |
            cd ./test-clients/ruby
            bundle install
            export SERVICE_URL=http://localhost:8081
            rake
      - save_cache:
          key: cache-{{ checksum "./test-clients/ruby/Gemfile.lock" }}
          paths:
            - ~/specgen-tests/ruby/vendor/bundle
      - store_test_results:
          path: ./test-clients/ruby/test-results

  client-scala-sttp:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/scala-sttp/build.sbt" }}
      - artifactory/setup-sbt:
          jfrog-server-url: specgen.jfrog.io
          repo-name: sbt
      - start-service:
          port: 8081
      - run:
          name: Test Scala sttp client
          command: |
            cd ./test-clients/scala-sttp
            export SERVICE_URL=http://localhost:8081
            mkdir -p ./test-results
            sbt -Djunitxml=./test-clients/test-results test < /dev/null
      - store_test_results:
          path: ./test-clients/scala-sttp/test-results
      - save_cache:
          key: cache-{{ checksum "./test-clients/scala-sttp/build.sbt" }}
          paths:
            - ~/.sbt
            - ~/.ivy2

  client-ts-axios-superstruct:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - attach_workspace:
          at: .
      - start-service:
          port: 8081
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
          scope: specgen.io
      - run:
          name: Setup npm
          command: |
            cd ./test-clients/ts-axios-superstruct
            npm install @specgen.io/specgen.io@$SPECGEN_VERSION --save-dev
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/ts-axios-superstruct/package.json" }}
      - run:
          name: Test axios client
          command: |
            cd ./test-clients/ts-axios-superstruct
            npm install
            npm run specgen
            export SERVICE_URL=http://localhost:8081
            mkdir -p ./test-results
            export JEST_JUNIT_OUTPUT_DIR=./test-results
            npm run test
      - save_cache:
          key: cache-{{ checksum "./test-clients/ts-axios-superstruct/package.json" }}
          paths:
            - ~/specgen-tests/ts-axios-superstruct/node_modules
      - store_test_results:
          path: ./test-clients/ts-axios-superstruct/test-results

  client-ts-node-fetch-superstruct:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - attach_workspace:
          at: .
      - start-service:
          port: 8081
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
          scope: specgen.io
      - run:
          name: Setup npm
          command: |
            cd ./test-clients/ts-node-fetch-superstruct
            npm install @specgen.io/specgen.io@$SPECGEN_VERSION --save-dev
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/ts-node-fetch-superstruct/package.json" }}
      - run:
          name: Test fetch client
          command: |
            cd ./test-clients/ts-node-fetch-superstruct
            npm install
            npm run specgen
            export SERVICE_URL=http://localhost:8081
            mkdir -p ./test-results
            export JEST_JUNIT_OUTPUT_DIR=./test-results
            npm run test
      - save_cache:
          key: cache-{{ checksum "./test-clients/ts-node-fetch-superstruct/package.json" }}
          paths:
            - ~/specgen-tests/ts-node-fetch-superstruct/node_modules
      - store_test_results:
          path: ./test-clients/ts-node-fetch-superstruct/test-results

  client-ts-browser-fetch-superstruct:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - attach_workspace:
          at: .
      - start-service:
          port: 8081
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
          scope: specgen.io
      - run:
          name: Setup npm
          command: |
            cd ./test-clients/ts-browser-fetch-superstruct
            npm install @specgen.io/specgen.io@$SPECGEN_VERSION --save-dev
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-clients/ts-browser-fetch-superstruct/package.json" }}
      - run:
          name: Build code
          command: |
            cd ./test-clients/ts-browser-fetch-superstruct
            npm install
            npm run specgen
            npm run build
      - run:
          name: Run browser
          command: |
            cd ./test-clients/ts-browser-fetch-superstruct
            npm run start
          background: true
      - wait-url:
          url: http://localhost:8082/
      - run:
          name: Test fetch client
          command: |
            cd ./test-clients/ts-browser-fetch-superstruct
            export SERVICE_URL=http://localhost:8081
            npm run test
      - save_cache:
          key: cache-{{ checksum "./test-clients/ts-browser-fetch-superstruct/package.json" }}
          paths:
            - ~/specgen-tests/ts-browser-fetch-superstruct/node_modules

  client-ts-axios-iots:
    environment:
      SPECGEN_VERSION: << pipeline.parameters.specgen-version >>
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - attach_workspace:
          at: .
      - start-service:
          port: 8081
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
          scope: specgen.io
      - run:
          name: Setup npm
          command: |
            cd ./test-clients/ts-axios-iots
            npm install @specgen.io/specgen.io@$SPECGEN_VERSION --save-dev
      - restore_cache:
          keys:
            - cache-{{ checksum "./ts-axios-iots/package.json" }}
      - run:
          name: Test axios client
          command: |
            cd ./test-clients/ts-axios-iots
            npm install
            npm run specgen
            export SERVICE_URL=http://localhost:8081
            mkdir -p ./test-results
            export JEST_JUNIT_OUTPUT_DIR=./test-results
            npm run test
      - save_cache:
          key: cache-{{ checksum "./ts-axios-iots/package.json" }}
          paths:
            - ~/specgen-tests/ts-axios-iots/node_modules
      - store_test_results:
          path: ./test-clients/ts-axios-iots/test-results

  service-tests:
    docker:
      - image: cimg/go:1.18.3
    working_directory: ~/specgen-tests
    steps:
      - checkout
      - run:
          name: Build tests
          command: |
            cd test-services/tests
            go test -c -o service-tests
      - persist_to_workspace:
          root: .
          paths:
            - test-services/tests

  service-scala-play:
    environment:
      SPECGEN_VERSION: <<pipeline.parameters.specgen-version>>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:8-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - cache-{{ checksum "./test-services/scala-play/build.sbt" }}
      - run:
          name: Create temp folder for tests results
          command: mkdir -p /tmp/test-results
      - artifactory/setup-sbt:
          jfrog-server-url: specgen.jfrog.io
          repo-name: sbt
      - run:
          name: Build service
          command: |
            cd ./test-services/scala-play
            sbt compile < /dev/null
      - run:
          name: Run service
          command: |
            cd ./test-services/scala-play
            sbt -Dhttp.port=8081 run < /dev/null
          background: true
      - save_cache:
          key: cache-{{ checksum "./test-services/scala-play/build.sbt" }}
          paths:
            - ~/.sbt
            - ~/.ivy2
      - wait-url:
          url: http://localhost:8081/docs/index.html?url=swagger.yaml
      - go-tests:
          command: ./test-services/tests/service-tests -test.v

  service-java:
    parameters:
      values-file:
        type: string
    environment:
      SPECGEN_VERSION: <<pipeline.parameters.specgen-version>>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Create temp folder for tests results
          command: mkdir -p /tmp/test-results
      - get-rendr
      - run:
          name: Copy spec.yaml
          command: |
            cd ./test-services
            cp ./spec.yaml ./java/template/spec.yaml
      - run:
          name: Generate service
          command: |
            export THE_ROOT=./test-services/java
            ./rendr file:///./templates/service-java --root file:///${THE_ROOT}/template --noinput --values ${THE_ROOT}/<<parameters.values-file>>.json --set versions.specgen=${SPECGEN_VERSION} --out ${THE_ROOT}/out
      - artifactory/setup-maven:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
      - restore_cache:
          key: java-<<parameters.values-file>>
      - yaml-execute:
          path: ./test-services/java/out
          yaml-file: .rendr.yaml
          yaml-path: .build
      - yaml-execute:
          path: ./test-services/java/out
          yaml-file: .rendr.yaml
          yaml-path: .run
          background: true
      - save_cache:
          key: java-<<parameters.values-file>>
          paths: [ ~/.m2 ]
      - wait-url:
          url: http://localhost:8081/swagger-ui/
      - go-tests:
          command: ./test-services/tests/service-tests -test.v

  service-kotlin:
    parameters:
      values-file:
        type: string
    environment:
      SPECGEN_VERSION: <<pipeline.parameters.specgen-version>>
    working_directory: ~/specgen-tests
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Create temp folder for tests results
          command: mkdir -p /tmp/test-results
      - get-rendr
      - run:
          name: Copy spec.yaml
          command: |
            cd test-services
            cp ./spec.yaml ./kotlin/template/spec.yaml
      - run:
          name: Generate service
          command: |
            export THE_ROOT=./test-services/kotlin
            ./rendr file:///./templates/service-kotlin --root file:///${THE_ROOT}/template --noinput --values ${THE_ROOT}/<<parameters.values-file>>.json --set versions.specgen=${SPECGEN_VERSION} --out ${THE_ROOT}/out
      - artifactory/setup-gradle-kotlin:
          jfrog-server-url: specgen.jfrog.io
          repo-name: maven
          project-path: ./test-services/kotlin/out
      - restore_cache:
          key: kotlin-<<parameters.values-file>>
      - yaml-execute:
          path: ./test-services/kotlin/out
          yaml-file: .rendr.yaml
          yaml-path: .build
      - yaml-execute:
          path: ./test-services/kotlin/out
          yaml-file: .rendr.yaml
          yaml-path: .run
          background: true
      - save_cache:
          key: kotlin-<<parameters.values-file>>
          paths: [ ~/.gradle ]
      - wait-url:
          url: http://localhost:8081/swagger-ui/
      - go-tests:
          command: ./test-services/tests/service-tests -test.v

  service-golang:
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/go:1.18.3
    steps:
      - checkout
      - attach_workspace:
          at: .
      - install_specgen_golang
      - run:
          name: Build service
          command: |
            cd ./test-services/go
            go generate
            go build
      - run:
          name: Run service
          command: |
            cd ./test-services/go
            go run service.go --port 8081
          background: true
      - wait-url:
          url: http://localhost:8081/docs/
      - go-tests:
          command: ./test-services/tests/service-tests -test.v

  service-typescript:
    parameters:
      values-file:
        type: string
    working_directory: ~/specgen-tests
    docker:
      - image: cimg/node:16.8.0
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Create temp folder for tests results
          command: mkdir -p /tmp/test-results
      - get-rendr
      - run:
          name: Copy spec.yaml
          command: |
            cd test-services
            cp ./spec.yaml ./typescript/template/spec.yaml
      - run:
          name: Generate service
          command: |
            export THE_ROOT=./test-services/typescript
            ./rendr file:///./templates/service-ts --root file:///${THE_ROOT}/template --noinput --values ${THE_ROOT}/<<parameters.values-file>>.json --set versions.specgen=${SPECGEN_VERSION} --out ${THE_ROOT}/out
      - artifactory/setup-npm:
          jfrog-server-url: specgen.jfrog.io
          repo-name: npm
          scope: specgen.io
      - restore_cache:
          key: typescript-<<parameters.values-file>>
      - yaml-execute:
          path: ./test-services/typescript/out
          yaml-file: .rendr.yaml
          yaml-path: .build
      - yaml-execute:
          path: ./test-services/typescript/out
          yaml-file: .rendr.yaml
          yaml-path: .run
          background: true
      - save_cache:
          key: typescript-<<parameters.values-file>>
          paths: [ ~/specgen-tests/test-services/typescript/out/node_modules ]
      - wait-url:
          url: http://localhost:8081/docs/
      - go-tests:
          command: ./test-services/tests/service-tests -test.v

  placeholder:
    docker:
      - image: cimg/base:2021.04
    steps:
      - run: echo "Just a placeholder job"


commands:
  attach_workspace_folder:
    parameters:
      workspace:
        type: string
        default: ./workspace
      folder:
        type: string
      at:
        type: string
    steps:
      - attach_workspace:
          at: <<parameters.workspace>>
      - run:
          name: Copy folder from attached workspace
          command: cp -a <<parameters.workspace>>/<<parameters.folder>>/. <<parameters.at>>
      - run:
          name: Inspect local folder
          command: find <<parameters.at>>

  github-push-tag:
    parameters:
      path:
        type: string
        default: .
      repo:
        type: string
      tag:
        type: string
      commit:
        type: boolean
        default: false
    steps:
      - run:
          name: Create tag and push to github
          command: |
            cd << parameters.path >>
            git config --global user.email $GITHUB_EMAIL
            git config --global user.name $GITHUB_USER
            git remote set-url origin https://$GITHUB_USER:$GITHUB_TOKEN@<< parameters.repo >>
            if [[ "<< parameters.commit >>" == "true" ]]; then
              git add --all
              if [[ `git status --porcelain` ]]; then
                git commit -m "Build << parameters.tag >>"
                git push
              else
                echo "No changes detected - nothing to commit"
              fi
            else
              echo "Changes commit was not requested"
            fi
            git tag -f -a << parameters.tag >> -m "Version: << parameters.tag >>"
            git push -f --tags

  install_specgen_golang:
    steps:
      - run:
          name: Build specgen-golang
          command: |
            cd ./codegen/golang
            go install
            mv ${GOPATH}/bin/golang ${GOPATH}/bin/specgen-golang 
            specgen-golang --help      

  build_specgen_plugin:
    parameters:
      plugin-path:
        type: string
    steps:
      - checkout
      - run:
          name: Build
          command: |
            cd <<parameters.plugin-path>>
            ../build.sh <<pipeline.parameters.specgen-version>>
      - persist_to_workspace:
          root: .
          paths:
            - <<parameters.plugin-path>>/dist

  setup-sonatype-maven:
    steps:
      - run:
          name: Add PGP secret key
          command: |
            mkdir -p ~/.gpg
            (echo "$SONATYPE_GPG_SECRET_KEY" | base64 -d) > ~/private.key
            gpg --batch --import ~/private.key
            gpg --list-keys
      - run:
          name: Setup Sonatype for Maven
          command: |
            mkdir -p ~/.m2
            tee > ~/.m2/settings.xml \<<END
            <settings>
              <servers>
                <server>
                  <id>ossrh</id>
                  <username>$SONATYPE_USER</username>
                  <password>$SONATYPE_PASSWORD</password>
                </server>
              </servers>
            </settings>
            END

  setup-sonatype-sbt:
    steps:
      - run:
          name: Setup Sonatype for SBT
          command: |
            mkdir -p ~/.sbt/1.0
            tee > ~/.sbt/1.0/sonatype.sbt \<<END
            credentials += Credentials("Sonatype Nexus Repository Manager", "oss.sonatype.org", "$SONATYPE_USER", "$SONATYPE_PASSWORD")
            publishTo := Some(Opts.resolver.sonatypeStaging)
            pgpPassphrase := Some("$SONATYPE_GPG_PASSPHRASE".toArray)
            END
      - run:
          name: Add sontype plugins
          command: |
            tee > ~/.sbt/1.0/scala_jfrog.sbt \<<END
            val scala_jfrog = "Scala JFrog" at "https://scala.jfrog.io/artifactory/sbt-plugin-releases"
            resolvers += scala_jfrog
            END
            mkdir -p ~/.sbt/1.0/plugins
            tee > ~/.sbt/1.0/plugins/sonatype.sbt \<<END
            addSbtPlugin("org.xerial.sbt" % "sbt-sonatype" % "2.3")
            addSbtPlugin("com.jsuereth" % "sbt-pgp" % "1.1.1")
            END
      - run:
          name: Write PGP secret key
          command: |
            mkdir -p ~/.sbt/gpg
            (echo "$SONATYPE_GPG_SECRET_KEY" | base64 -d) > ~/.sbt/gpg/secring.asc
  setup-rubygems:
    steps:
      - run:
          name: Write key
          command: |
            mkdir ~/.gem
            tee > ~/.gem/credentials \<<END
            ---
            :rubygems_api_key: $RUBYGEMS_API_KEY
            END
            chmod 600 ~/.gem/credentials

  setup-gems:
    parameters:
      jfrog-server-url:
        type: string
      repo-name:
        type: string
    steps:
      - run:
          name: Setup Artifactory for RubyGems
          command: |
            export JFROG_USER_SAFE=$(echo "$JFROG_USER" | sed "s/@/%40/")
            gem source --add https://$JFROG_USER_SAFE:$JFROG_PASS@<< parameters.jfrog-server-url >>/artifactory/api/gems/<< parameters.repo-name >>/
            curl -u$JFROG_USER:$JFROG_PASS https://<< parameters.jfrog-server-url >>/artifactory/api/gems/<< parameters.repo-name >>/api/v1/api_key.yaml > ~/.gem/credentials
            chmod 600 ~/.gem/credentials


  start-service:
    parameters:
      port:
        type: integer
    steps:
      - run:
          name: Start test-service
          command: ./test-clients/test-service/test-service --port << parameters.port >>
          background: true
      - wait-url:
          url: http://localhost:<< parameters.port >>/

  wait-url:
    parameters:
      url:
        type: string
      sleep:
        type: integer
        default: 5
      attempts:
        type: integer
        default: 12
    steps:
      - run:
          name: Wait until url is available
          command: |
            attempt_counter=0
            max_attempts=<< parameters.attempts >>

            until $(curl --output /dev/null --silent --head --fail << parameters.url >>); do
              if [ ${attempt_counter} -eq ${max_attempts} ];then
                echo "Max attempts reached"
                exit 1
              fi

              printf '.'
              attempt_counter=$(($attempt_counter+1))
              sleep << parameters.sleep >>
            done



  go-tests:
    parameters:
      command:
        type: string
        default: go test
    steps:
      - run:
          name: Install go-junit-report
          command: |
            curl -L https://github.com/specgen-io/go-junit-report/releases/download/latest/go-junit-report_linux_amd64.zip > go-junit-report.zip
            unzip -o go-junit-report.zip
      - run:
          name: Run tests
          command: |
            mkdir -p ./test-results
            <<parameters.command>> 2>&1 | ./go-junit-report > ./test-results/go-test-report.xml
      - store_test_results:
          path: ./test-results
  get-specgen:
    steps:
      - run:
          name: Get specgen
          command: |
            curl -L -H "X-JFrog-Art-Api:${JFROG_PASS}" -O "https://specgen.jfrog.io/artifactory/binaries/specgen/v<<pipeline.parameters.specgen-version>>/specgen_linux_amd64.zip"
            unzip -o specgen_linux_amd64.zip
            ./specgen help
  get-rendr:
    steps:
      - run:
          name: Get rendr
          command: |
            curl -L -H "X-JFrog-Art-Api:${JFROG_PASS}" -O "https://specgen.jfrog.io/artifactory/binaries/rendr/<<pipeline.parameters.rendr-version>>/rendr_linux_amd64.zip"
            unzip -o rendr_linux_amd64.zip
            ./rendr --help
  yaml-execute:
    parameters:
      path:
        type: string
      yaml-file:
        type: string
      yaml-path:
        type: string
      background:
        type: boolean
        default: false
    steps:
      - install-yq
      - run:
          name: Run commands from YAML file
          command: |
            cd <<parameters.path>>
            export COMMANDS=$(yq eval <<parameters.yaml-path>> <<parameters.yaml-file>>)
            echo "Commands:"
            echo "$COMMANDS"
            echo "$COMMANDS" | while read THE_COMMAND ; do
              echo "Executing: $THE_COMMAND"
              $THE_COMMAND
            done
          background: <<parameters.background>>
  install-yq:
    steps:
      - run:
          name: Install yq
          command: |
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod a+x /usr/local/bin/yq
            yq --version


workflows:
  build-release:
    jobs:


      - golang:
          context: specgen
      - placeholder:
          name: golang-no-plugin
          requires: [golang]
      - placeholder:
          name: golang-build
          requires: [golang-no-plugin]
      - models-golang:
          context: specgen
          requires: [golang-build]
      - service-tests:
          name: service-tests-golang
          requires: [golang-build]
      - service-golang:
          context: specgen
          requires: [service-tests-golang]
      - client-test-service:
          name: client-test-service-golang
          context: specgen
          requires: [golang-build]
      - client-golang:
          context: specgen
          requires: [client-test-service-golang]
      - placeholder:
          name: completed-golang
          requires:
            - models-golang
            - service-golang
            - client-golang


      - java:
          context: specgen
      - maven-java:
          context: specgen
          requires: [java]
      - gradle-java:
          context: specgen
          requires: [java]
      - placeholder:
          name: java-build
          requires: [maven-java, gradle-java]
      - models-java-jackson:
          context: specgen
          requires: [java-build]
      - models-java-moshi:
          context: specgen
          requires: [java-build]
      - service-tests:
          name: service-tests-java
          requires: [java-build]
      - service-java:
          matrix:
            parameters:
              values-file: ["micronaut-jackson", "micronaut-moshi", "spring-jackson", "spring-moshi"]
          context: specgen
          requires: [service-tests-java]
      - client-test-service:
          name: client-test-service-java
          context: specgen
          requires: [java-build]
      - client-java-okhttp-jackson:
          context: specgen
          requires: [client-test-service-java]
      - client-java-okhttp-moshi:
          context: specgen
          requires: [client-test-service-java]
      - client-java-micronaut-jackson:
          context: specgen
          requires: [client-test-service-java]
      - placeholder:
          name: completed-java
          requires:
            - models-java-jackson
            - models-java-moshi
            - service-java
            - client-java-okhttp-jackson
            - client-java-okhttp-moshi
            - client-java-micronaut-jackson


      - kotlin:
          context: specgen
      - maven-kotlin:
          context: specgen
          requires: [kotlin]
      - gradle-kotlin:
          context: specgen
          requires: [kotlin]
      - placeholder:
          name: kotlin-build
          requires: [maven-kotlin, gradle-kotlin]
      - models-kotlin:
          matrix:
            parameters:
              values-file: ["jackson", "moshi"]
          context: specgen
          requires: [kotlin-build]
      - service-tests:
          name: service-tests-kotlin
          requires: [kotlin-build]
      - service-kotlin:
          matrix:
            parameters:
              values-file: ["micronaut-jackson", "micronaut-moshi", "spring-jackson", "spring-moshi"]
          context: specgen
          requires: [service-tests-kotlin]
      - client-test-service:
          name: client-test-service-kotlin
          context: specgen
          requires: [kotlin-build]
      - client-kotlin-okhttp-jackson:
          context: specgen
          requires: [client-test-service-kotlin]
      - client-kotlin-okhttp-moshi:
          context: specgen
          requires: [client-test-service-kotlin]
      - client-kotlin-micronaut-jackson:
          context: specgen
          requires: [client-test-service-kotlin]
      - placeholder:
          name: completed-kotlin
          requires:
            - models-kotlin
            - service-kotlin
            - client-kotlin-okhttp-jackson
            - client-kotlin-okhttp-moshi
            - client-kotlin-micronaut-jackson


      - typescript:
          context: specgen
      - npm-typescript:
          context: specgen
          requires: [typescript]
      - placeholder:
          name: typescript-build
          requires: [npm-typescript]
      - models-ts-superstruct:
          context: specgen
          requires: [typescript-build]
      - models-ts-iots:
          context: specgen
          requires: [typescript-build]
      - service-tests:
          name: service-tests-typescript
          requires: [typescript-build]
      - service-typescript:
          matrix:
            parameters:
              values-file: ["express-superstruct", "express-iots", "koa-superstruct", "koa-iots"]
          context: specgen
          requires: [service-tests-typescript]
      - client-test-service:
          name: client-test-service-typescript
          context: specgen
          requires: [typescript-build]
      - client-ts-axios-superstruct:
          context: specgen
          requires: [client-test-service-typescript]
      - client-ts-axios-iots:
          context: specgen
          requires: [client-test-service-typescript]
      - client-ts-node-fetch-superstruct:
          context: specgen
          requires: [client-test-service-typescript]
      - client-ts-browser-fetch-superstruct:
          context: specgen
          requires: [client-test-service-typescript]
      - placeholder:
          name: completed-typescript
          requires:
            - models-ts-superstruct
            - models-ts-iots
            - service-typescript
            - client-ts-axios-superstruct
            - client-ts-axios-iots
            - client-ts-node-fetch-superstruct
            - client-ts-browser-fetch-superstruct


      - ruby:
          context: specgen
      - gem:
          context: specgen
          requires: [ruby]
      - placeholder:
          name: ruby-build
          requires: [gem]
      - models-ruby:
          context: specgen
          requires: [ruby-build]
      - client-test-service:
          name: client-test-service-ruby
          context: specgen
          requires: [ruby-build]
      - client-ruby:
          context: specgen
          requires: [client-test-service-ruby]
      - placeholder:
          name: completed-ruby
          requires:
            - models-ruby
            - client-ruby


      - scala:
          context: specgen
      - sbt:
          context: specgen
          requires: [scala]
      - placeholder:
          name: scala-build
          requires: [sbt]
      - models-scala-circe:
          context: specgen
          requires: [scala-build]
      - service-tests:
          name: service-tests-scala
          requires: [scala-build]
      - service-scala-play:
          context: specgen
          requires: [service-tests-scala]
      - client-test-service:
          name: client-test-service-scala
          context: specgen
          requires: [scala-build]
      - client-scala-sttp:
          context: specgen
          requires: [client-test-service-scala]
      - placeholder:
          name: completed-scala
          requires:
            - models-scala-circe
            - service-scala-play
            - client-scala-sttp


      - specgen:
          context: specgen


      - approve-release:
          type: approval
          requires:
            - specgen
            - completed-golang
            - completed-java
            - completed-kotlin
            - completed-typescript
            - completed-scala
            - completed-ruby
          filters:
            branches:
              only:
                - main
                - /v.*/
      - specgen-release:
          context: specgen
          requires: [approve-release]
      - golang-release:
          context: specgen
          requires: [approve-release]
      - maven-java-sonatype:
          context: specgen
          requires: [approve-release]
      - maven-kotlin-sonatype:
          context: specgen
          requires: [maven-java-sonatype]
      - sbt-sonatype:
          context: specgen
          requires: [maven-kotlin-sonatype]
      - gradle-java-pluginportal:
          context: specgen
          requires: [approve-release]
      - gradle-kotlin-pluginportal:
          context: specgen
          requires: [approve-release]
      - npm-npmjs:
          context: specgen
          requires: [approve-release]
      - gem-rubygems:
          context: specgen
          requires: [approve-release]
